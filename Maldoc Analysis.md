## MalDocs

One of the most effective ways in which adversaries can infect a system is through a Microsoft Office
document via embedding a macro (written in VBA) in the file.
Malicious macros are typically written to run automatically after the victim opens the document and clicks the button enabling the macro.
Once active, the macro can perform risky actions, such as download files, save them to the file system or execute arbitrary programs. 
The adversary can use macros as a downloader or dropper.

#### Microsoft Office documents formats:

- The "legacy" binary format **OLE2** (Structured Storage)
   - Mimics capabilities of a file system, using the concepts of storages (like folders) and streams (like files).
- The more modern XML-based format **OOXML** (Starting with Microsoft Office 2007)
  - Incorporates multiple files that include the document's contents in a ZIP file.
  - Macros are kept inside a binary OLE2 file, which is included within the zip archive and typically named **vbaProject.bin**

**Notes:**
- Both formats can carry macros, but the names of XML-based files need to have extensions that ends with "m" for macros to run,
however there is bypass via downloading template file so check **word/_rels/settings.xml.rels**
- OLE2 format support macros regardless of how the documents' files are named
- For Excel, the auto-run function is named Workbook_Open
- Excel supports XLM macros that are embedded as formulas in sheets without the OLE2 binary file.
- 


## Tools
[Oletools](https://github.com/decalage2/oletools) by Philippe Lagadec (e.g. olevba.py, oledump.py, oleid.py rely on vba source code)  
[pcodedmp.py](https://github.com/bontchev/pcodedmp) by Vesselin Bontchev (for p-code analysis, when source code is not available)  
SciTE editor

## Useful Links
https://zeltser.com/analyzing-malicious-documents/  
https://exploitreversing.com/2021/11/02/malicious-document-analysis-example-1/
