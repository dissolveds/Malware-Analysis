## MalDocs

One of the most effective ways in which adversaries can infect a system is through a Microsoft Office
document via embedding a macro (written in VBA) in the file.
Malicious macros are typically written to run automatically after the victim opens the document and clicks the button enabling the macro.
Once active, the macro can perform risky actions, such as download files, save them to the file system or execute arbitrary programs. 
The adversary can use macros as a downloader or dropper.

#### Microsoft Office documents formats:

- The "legacy" binary format **OLE2** (Structured Storage)
   - Mimics capabilities of a file system, using the concepts of storages (like folders) and streams (like files).
- The more modern XML-based format **OOXML** (Starting with Microsoft Office 2007)
  - Incorporates multiple files that include the document's contents in a ZIP file.
  - Macros are kept inside a binary OLE2 file, which is included within the zip archive and typically named **vbaProject.bin**

**Notes:**
- Both formats can carry macros, but the names of XML-based files need to have extensions that ends with "m" for macros to run,
however there is bypass via downloading template file so check **word/_rels/settings.xml.rels**
- OLE2 format support macros regardless of how the documents' files are named
- For Excel, the auto-run function is named Workbook_Open
- Excel supports XLM macros that are embedded as formulas in sheets without the OLE2 binary file.

## Use cases

- For non-password protected macro you can click the **View>Macros button**, which enables you to examine the macro embedded in the file without enabling Macro
- **olevba.py** command-line tool, automatically parses contents of Microsoft Office file and extracting the embedded macros.
  At the end of its output, it shows a table that summarizes the risky keywords it found in the extracted macro.  

  **olevba.py malicious_document.docm | more**  

- Check the contents of the malicious document without opening the file in Microsoft Word:

  **unzip malicious_document.docm -d malicious_document**  
  **scite malicious_document/word/document.xml**

- You can use strings command to find interesting IOCs, (e.g. CnC domain)  

  **unzip malicious_document.docm -d malicious_document**  (for OOXML)  
  **strings --encoding=l vbaProject.bin | grep <interesting_string>** 
 
- Explore the structure and contents of OLE2 files
 
  **oledump.py vbaProject.bin** or  
  **oledump.py malicious_document.docm** (it will automatically locate OLE2 file)  

- The stream which has macro will have **"M"** next to item number, d is used to decompress the macro:

  **oledump.py -s <item_number> -d vbaProject.bin | more**  (alternative to olevba.py)  

- Decodes embedded URLs:
  
  **oledump.py malicious_document.docm -p plugin_http_heuristics**

- Some of the items may have **"SRP"** in it's name, which acts as a **cache** and may contain **artifacts embedded in an earlier version of macro**  (e.g. when adversary modifies the original document to include new macros, rather than creating a brand-new malicious document, it can gibve clue on the potential origin and earlier use).
  
## Macro deobfuscation techniques

Sometimes easiest way of eobfuscating macros is via VBA debugger built into Microsoft Office:

- Extract macros using oletools
- Create a new blank Office document
- Create a new macro with any name, e.g. "MyMacro."
- Delete the empty MyMacro function in the Project editor.
- Paste the code that you extracted from the malicious document into the empty Project editor window. 
- At the top of that code, you might see lines that start with the Attribute keyword, remove those lines.
- Activate the Locals window, which will enable you to look at contents of variables when you debug the macro (View > Locals Window).
- Set breakpoints on "interesting" code; then run the macro and examine variables in Locals Window.



## Tools
[Oletools](https://github.com/decalage2/oletools) by Philippe Lagadec (e.g. olevba.py, oledump.py, oleid.py rely on vba source code)  
[pcodedmp.py](https://github.com/bontchev/pcodedmp) by Vesselin Bontchev (for p-code analysis, when source code is not available)  
SciTE editor

## Useful Links
https://zeltser.com/analyzing-malicious-documents/  
https://exploitreversing.com/2021/11/02/malicious-document-analysis-example-1/
